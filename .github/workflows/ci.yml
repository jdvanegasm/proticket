name: ProTicket CI

on:
  push:
    branches: [ feature/dockerization ]
  pull_request:

jobs:
  # ==============================
  # Java Auth Backend - Tests
  # ==============================
  auth-backend-tests:
    name: Auth backend (Java) tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/backend/auth
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run unit + Cucumber tests
        run: mvn -B test

  # ==============================
  # Python Business Backend - Tests
  # ==============================
  business-backend-tests:
    name: Business backend (Python) tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/backend/business
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: pytest || echo "No Python tests defined yet"

  # ==============================
  # Frontend - Build
  # ==============================
  frontend-build:
    name: Frontend build (Vite + React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app/frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

  # ==============================
  # Docker images build check
  # ==============================
  docker-build-check:
    name: Docker images build
    runs-on: ubuntu-latest
    needs:
      - auth-backend-tests
      - business-backend-tests
      - frontend-build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build auth image
        run: docker build -t proticket/auth:ci app/backend/auth

      - name: Build business image
        run: docker build -t proticket/business:ci app/backend/business

      - name: Build frontend image
        run: docker build -f Dockerfile -t proticket/frontend:ci app/frontend